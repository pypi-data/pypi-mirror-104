{% extends 'base.html' %}
{% load custom_tags_and_filters %}
{% block title %}{% if form.instance.pk %}Edit{% else %}New{% endif %} project{% endblock %}
{% block content %}
	{% with edit=form.instance.pk %}
		<h1 class="form-group">{% if edit %}Edit{% else %}New{% endif %} project</h1>
		{% if form.non_field_errors %}
			<div class="alert alert-danger">
				Oops! Something went wrong. The project was not created because:<br>
				{{ form.non_field_errors }}
			</div>
		{% endif %}
		<form method="post" action="{% if edit %}{% url 'invoices_edit_project' form.instance.id %}{% else %}{% url 'invoices_create_project' %}{% endif %}" class="form-horizontal">
			{% csrf_token %}
			<div class="form-group">
				<label for="name" class="control-label col-sm-2">Name</label>
				<div class="col-sm-4">
					<input type="text" name="name" id="name" maxlength="100" class="form-control" value="{{ form.name.value|default_if_none:'' }}" autofocus required>
				</div>
				<div class="col-sm-6 form-control-static danger-highlight">
					{{ form.name.errors|striptags }}
				</div>
			</div>
			<div class="form-group">
				<label for="account_search" class="control-label col-sm-2">Account</label>
				<div class="col-sm-4">
					<input type="text" id="account_search" name="account" class="form-control" value="{{ form.account.value|default_if_none:"" }}" {% if form.account.value %}style="display:none"{% else %} required{% endif %}>
					<input type="button" id="selected_account" class="btn btn-default" onclick="clear_account_selection()" value="{% if edit %}{{ form.instance.account }}{% else %}{{ form.cleaned_data.account|default_if_none:"" }}{% endif %}" style="{% if not form.account.value %}display:none{% endif %}">
				</div>
				<div class="col-sm-6 form-control-static danger-highlight">
					{{ form.account.errors|striptags }}
				</div>
			</div>
			<div class="form-group">
				<label for="application_identifier" class="control-label col-sm-2">Application identifier</label>
				<div class="col-sm-4">
					<input type="text" name="application_identifier" id="application_identifier" maxlength="100" class="form-control" value="{{ form.application_identifier.value|default_if_none:'' }}" required>
				</div>
				<div class="col-sm-6 form-control-static danger-highlight">
					{{ form.application_identifier.errors|striptags }}
				</div>
			</div>
			{% if rate_categories %}
				<div class="form-group">
					<label for="category" class="control-label col-sm-2">Rate Category</label>
					<div class="col-sm-4">
						<select name="category" id="category" class="form-control" required>
							<option disabled selected value="">&nbsp;</option>
							{% for rate_category in rate_categories %}
								<option value="{{ rate_category.id }}" {% if rate_category.id == form_details.category.value|to_int %}selected{% endif %}>{{ rate_category.name|default_if_none:'' }}</option>
							{% endfor %}
						</select>
					</div>
					<div class="col-sm-6 form-control-static danger-highlight">
						{{ form_details.category.errors|striptags }}
					</div>
				</div>
			{% endif %}
			<div class="form-group">
				<label for="project_name" class="control-label col-sm-2">Name for invoice</label>
				<div class="col-sm-4">
					<input type="text" name="project_name" id="project_name" class="form-control" value="{{ form_details.project_name.value|default_if_none:'' }}">
					<div class="form-control-static"><small><i>{{ form_details.project_name.help_text }}</i></small></div>
				</div>
				<div class="col-sm-6">
					<div class="form-control-static danger-highlight">{{ form_details.project_name.errors|striptags }}</div>
				</div>
			</div>
			<div class="form-group">
				<label for="contact_name" class="control-label col-sm-2">Contact name</label>
				<div class="col-sm-4">
					<input type="text" name="contact_name" id="contact_name" class="form-control" value="{{ form_details.contact_name.value|default_if_none:'' }}">
				</div>
				<div class="col-sm-6 form-control-static danger-highlight">
					{{ form_details.contact_name.errors|striptags }}
				</div>
			</div>
			<div class="form-group">
				<label for="contact_email" class="control-label col-sm-2">Email</label>
				<div class="col-sm-4">
					<input type="text" name="contact_email" id="contact_email" class="form-control" value="{{ form_details.contact_email.value|default_if_none:'' }}">
					<div class="form-control-static"><small><i>{{ form_details.contact_email.help_text }}</i></small></div>
				</div>
				<div class="col-sm-6 form-control-static danger-highlight">
					{{ form_details.contact_email.errors|striptags }}
				</div>
			</div>
			<div class="form-group">
				<label for="details" class="control-label col-sm-2">Details</label>
				<div class="col-sm-4">
					<textarea rows="6" name="details" id="details" class="form-control">{{ form_details.details.value|default_if_none:'' }}</textarea>
					<div class="form-control-static"><small><i>Details (address, atn etc.) will be displayed on the invoice</i></small></div>
				</div>
				<div class="col-sm-6 form-control-static danger-highlight">
					{{ form_details.details.errors|striptags }}
				</div>
			</div>
			<div class="form-group">
				<div class="col-sm-offset-2 col-sm-10">
					<div class="checkbox">
						<label>
							<input type="checkbox" name="no_charge" {% if form_details.no_charge.value %}checked{% endif %}> No charge (invoices will not be generated for this project)
						</label>
					</div>
				</div>
			</div>
			<div class="form-group">
				<div class="col-sm-offset-2 col-sm-10">
					<div class="checkbox">
						<label>
							<input type="checkbox" name="active" {% if form.active.value %}checked{% endif %}> Active
						</label>
					</div>
				</div>
			</div>
			<div class="form-group">
				<div class="col-sm-offset-2 col-sm-10">
					<input type="submit" class="btn btn-success" value="{% if edit %}Save changes{% else %}Create new project{% endif %}">
				</div>
			</div>
		</form>
		<script>
			function select_pi(jquery_event, search_selection, dataset_name)
			{
				$('#pi_search').typeahead('val', search_selection.id).hide();
				$("#selected_pi").val(search_selection.name).show();
			}
			function clear_pi_selection()
			{
				$("#selected_pi").hide();
				$('#pi_search').typeahead('val', '').show().focus();
			}
			function select_account(jquery_event, search_selection, dataset_name)
			{
				$('#account_search').typeahead('val', search_selection.id).hide();
				$("#selected_account").val(search_selection.name).show();
			}
			function clear_account_selection()
			{
				$("#selected_account").hide();
				$('#account_search').typeahead('val', '').show().focus();
			}
			window.addEventListener('load', function ()
			{
			    $('#pi_search').autocomplete('pi', select_pi, {{ user_list|json_search_base }});
				$('#account_search').autocomplete('account', select_account, {{ account_list|json_search_base }});
			});
		</script>
	{% endwith %}
{% endblock %}